# Tags allow to enable/disable certain components of kubefarm as defined in requirements.yaml
# https://docs.helm.sh/developing_charts/#tags-and-condition-fields-in-requirements-yaml
# 
# tags:
#   kubernetes: true

# ------------------------------------------------------------------------------
# Kubernetes control-plane
# ------------------------------------------------------------------------------
kubernetes:
  persistence:
    enabled: true
    storageClassName: local-path

  apiserver:
    service:
      type: LoadBalancer
      annotations:
        metallb.universe.tf/allow-shared-ip: ltsp1

# ------------------------------------------------------------------------------
# Kubeadm token generator
# (tokens are needed to join nodes to the cluster)
# ------------------------------------------------------------------------------
tokenGenerator:
  tokenTtl: 24h0m0s
  schedule: "0 */12 * * *"

# ------------------------------------------------------------------------------
# Network boot server configuration
# ------------------------------------------------------------------------------
ltsp:
  publishDHCP: true
  service:
    type: LoadBalancer
    annotations:
      metallb.universe.tf/allow-shared-ip: ltsp1

  config:
    kernelOptions: []
      #- forcepae
      #- console=tty1
      #- console=ttyS0,9600n8
      #- nvme_core.default_ps_max_latency_us=0

    dockerConfig:
      exec-opts: [ native.cgroupdriver=systemd ]
      iptables: false
      ip-forward: false
      bridge: none
      log-driver: journald
      storage-driver: overlay2

    sshAuthorizedKeys: []
      #- ssh-rsa AAAAB3N...
    #rootPasswd: $1$VVosH8FD$G5W3LZJC7479RsVUnng051 # `openssl passwd -1`

    disableAutoupdate: true

    timezone: UTC # from /usr/share/zoneinfo/<timezone>

    sysctls:
      net.ipv4.ip_forward: 1

    modules:
      - br_netfilter
      #- ip_vs
      #- ip_vs_rr
      #- ip_vs_wrr
      #- ip_vs_sh

    options:
      OMIT_FUNCTIONS: "pam_main mask_services_main"
      POST_INIT_FIX_HOSTS: 'sed -i "s/^127.0.1.1/\${IP_ADDRESS}/g" /etc/hosts'

    sections: {}
      #init/: |
      #  cp /etc/ltsp/foo.txt /tmp/foo.txt

    extraFiles: {}
      #foo.txt: |
      #   echo "Hello world!"

# ------------------------------------------------------------------------------
# Nodes configuration
# ------------------------------------------------------------------------------

nodePools:
  - nodes:
      - name: node1
        mac: aa:bb:cc:dd:ee:ff
        clientIDs: ['*']
        ip: 192.168.0.101
    tags:
      - default

# ------------------------------------------------------------------------------
# Tags specific configuration
# ------------------------------------------------------------------------------

tags:
  dhcpOptions:
    # dnsmasq options list
    # see available options (https://git.io/JJ0dH)
    all: {}
    default: {}
      #router: 192.168.0.1
      #dns-server: 192.168.0.1
      #broadcast: 192.168.255.255
      #domain-search: infra.example.org

  ltspOptions:
    all:
      DEBUG_SHELL: "1"
      FSTAB_KUBELET: "tmpfs /var/lib/kubelet tmpfs x-systemd.wanted-by=kubelet.service 0 0"
      FSTAB_DOCKER: "tmpfs /var/lib/docker tmpfs x-systemd.wanted-by=docker.service 0 0"
    default: #{}
      DEBUG_SHELL: "1"

  # TODO: https://github.com/kubernetes/kubeadm/issues/202#issuecomment-302929790
  kubernetesLabels:
    all: {}
    default: {}
      #label1: value1
      #label2: value2

  kubernetesTaints:
    all: {}
    default: {}
      #- effect: NoSchedule
      #  key: foo
      #  value: bar

